# Easy-Stun Unraid 插件

这是一个为 Unraid 系统设计的 Easy-Stun NAT穿透插件，基于 easy-stun 项目开发。

## 功能特性

- **NAT穿透与端口暴露**：通过 STUN 协议获取公网映射地址
- **多隧道管理**：支持同时运行多个隧道实例
- **Web管理界面**：提供完整的 Web UI 管理功能
- **自定义端口**：支持自定义 Web 管理界面端口（1024-65535）
- **仪表板集成**：在 Unraid 主仪表板显示服务状态
- **实时监控**：5秒自动刷新状态信息
- **日志管理**：支持日志查看、清理和自动轮转
- **开机启动**：支持开机自动启动服务

## 安装要求

1. **Unraid 版本**：6.12.0 或更高
2. **网络环境**：需要能够访问 GitHub 和 STUN 服务器
3. **wget 工具**：用于下载二进制文件

## 安装步骤

### 1. 安装插件

将 `easy-stun.plg` 文件复制到 Unraid 的插件目录：

```bash
cp /boot/config/plugins/xing/easy-stun-unraid/easy-stun.plg /boot/config/plugins/
```

### 2. 在 Unraid 中安装

1. 打开 Unraid Web 界面
2. 进入 "Apps" 页面
3. 点击 "Install Plugin" 按钮
4. 选择 `easy-stun.plg` 文件进行安装

**注意**：插件安装时会自动从 [GitHub](https://github.com/wlaosj/easy-stun/raw/refs/heads/main/easy-stun) 下载最新的 easy-stun 二进制文件，并采用双重存储机制：
- **U盘存储**：`/boot/config/plugins/easy-stun/easy-stun`（持久化保存）
- **内存存储**：`/usr/local/bin/easy-stun`（系统PATH，重启后自动从U盘恢复）

## 使用方法

### 1. 基本操作

安装完成后，可以在以下位置找到插件：

- **主界面**：Settings → Easy-Stun
- **仪表板**：Dashboard 页面会显示服务状态

### 2. Web 管理界面

插件启动后，可以通过以下地址访问 Web 管理界面：

```
http://[Unraid-IP]:[端口]/
```

**默认端口**：18080（可在插件界面自定义修改）

**端口配置**：
- 在插件主界面找到"Web端口配置"部分
- 输入端口号（1024-65535范围）
- 点击"保存"按钮即可生效

### 3. 配置隧道

在 Web 管理界面中：

1. 点击 "新增穿透实例"
2. 填写配置信息：
   - **名称**：隧道备注名
   - **协议**：TCP 或 UDP
   - **监听端口**：本地绑定端口（0 表示自动分配）
   - **内网主机**：目标内网 IP
   - **内网端口**：目标内网端口
   - **保活间隔**：保活间隔秒数（默认15秒）
   - **自动启动**：是否开机自动启动
   - **有效性检测**：是否启用 WAN 检测
3. 点击 "创建" 按钮

### 4. 管理隧道

- **启动/停止**：点击对应按钮控制隧道状态
- **编辑**：修改隧道配置
- **删除**：删除不需要的隧道
- **查看状态**：实时查看隧道运行状态和公网地址

## 配置说明

### 配置文件位置

```
/boot/config/plugins/easy-stun/tunnels.json  # 隧道配置文件
/boot/config/plugins/easy-stun/port.conf     # 端口配置文件
```

### 日志文件位置

```
/var/log/easy-stun.log
```

### 端口配置

插件支持自定义 Web 管理界面的端口：

1. 在插件主界面找到"Web端口配置"部分
2. 输入端口号（1024-65535范围）
3. 点击"保存"按钮
4. 重启服务使配置生效

**端口配置特点**：
- 支持 1024-65535 端口范围
- 配置自动保存到 `/boot/config/plugins/easy-stun/port.conf`
- 无效端口会自动回退到默认端口 18080
- 配置修改后需要重启服务才能生效

### 开机启动配置

插件支持开机自动启动，可以在主界面中启用：

1. 勾选 "开机自动启动 Easy-Stun"
2. 点击保存

## 故障排除

### 1. 服务无法启动

- 检查 easy-stun 二进制文件是否存在：`/usr/local/bin/easy-stun`
- 查看日志文件：`/var/log/easy-stun.log`
- 确认配置文件格式正确

### 2. 隧道无法建立

- 检查网络连接是否正常
- 确认 STUN 服务器可访问
- 检查防火墙设置
- 查看详细日志信息

### 3. Web 界面无法访问

- 确认服务正在运行
- 检查配置的端口是否被占用
- 确认端口配置正确（1024-65535范围）
- 查看防火墙设置
- 检查端口配置文件：`/boot/config/plugins/easy-stun/port.conf`

## 卸载插件

在 Unraid 插件管理页面中卸载，或手动执行：

```bash
rm -f /boot/config/plugins/easy-stun.plg
```

## 技术细节

### 插件架构

- **主程序**：easy-stun 二进制文件
- **Web界面**：集成在插件中的管理界面
- **API接口**：提供状态查询和操作接口
- **脚本系统**：处理启动、停止、状态检查等操作
- **配置管理**：支持隧道配置和端口配置的持久化存储

### 安全特性

- 遵循 Unraid 插件开发安全规范
- 使用标记块安全修改系统文件
- 正确的 XML 转义处理
- 完善的错误处理和日志记录

## 开发信息

- **作者**：隔壁小王
- **版本**：1.0.0
- **基于项目**：easy-stun
- **支持**：https://github.com/wlaosj/easy-stun

## 许可证

本项目以开源学习与工程实践为目的，请合理使用。
